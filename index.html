<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kontrol Palet Hanwa (Google Sheet API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-app {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0d47a1;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            <p class="text-white mt-3 text-lg">Menghubungkan ke Google Sheets...</p>
        </div>
    </div>

    <div class="container-app mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">Kontrol Palet Hanwa (via Google Sheet API)</h1>

        <!-- Connection Status -->
        <div id="auth-status" class="bg-green-100 p-3 rounded-lg text-green-800 mb-6">
            <p>Status Koneksi: <span class="font-semibold">URL Web App terpasang. Harap pastikan Apps Script sudah di-deploy.</span></p>
            <p class="text-xs mt-1">Sheet ID Google Sheet: 1YiIDIa0Ysi-O0k4askOtd8Qf66KnQuJxlLMngDlwaM1A</p>
        </div>

        <!-- Tabs -->
        <div class="flex mb-6 border-b border-gray-300">
            <button onclick="switchTab('master')" class="tab-btn p-3 font-semibold text-sm md:text-base border-b-2 border-blue-600 text-blue-600 transition duration-150 ease-in-out" id="tab-master">Master Palet</button>
            <button onclick="switchTab('transaction')" class="tab-btn p-3 font-semibold text-sm md:text-base text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" id="tab-transaction">Log Transaksi Palet</button>
        </div>

        <!-- Master Palet Tab Content -->
        <div id="content-master" class="tab-content">
            <!-- Master Palet Form -->
            <div class="card bg-white p-6 rounded-xl mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Master Palet Baru</h2>
                <form id="master-palet-form" onsubmit="window.handleMasterPaletSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="masterPaletId" name="masterPaletId" placeholder="ID Palet (Ex: HNW-A101)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <select id="masterPaletType" name="masterPaletType" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Tipe Palet</option>
                            <option value="Standard">Standard</option>
                            <option value="Heavy Duty">Heavy Duty</option>
                            <option value="Lightweight">Lightweight</option>
                        </select>
                        <input type="text" id="masterPaletLocation" name="masterPaletLocation" placeholder="Lokasi Awal (Ex: Gudang A)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="number" id="masterPaletCapacity" name="masterPaletCapacity" placeholder="Kapasitas Angkut (Kg)" value="1000" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="mt-6 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg btn-primary hover:bg-blue-700">
                        Simpan Master Palet
                    </button>
                </form>
            </div>

            <!-- Master Palet List -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Daftar Master Palet (<span id="master-palet-count">0</span>)</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Palet</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kapasitas (Kg)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Diperbarui</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-palet-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaksi Palet Tab Content -->
        <div id="content-transaction" class="tab-content hidden">
            <!-- Transaksi Form -->
            <div class="card bg-white p-6 rounded-xl mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Transaksi Palet</h2>
                <form id="transaction-form" onsubmit="window.handleTransactionSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="transactionPaletId" name="transactionPaletId" placeholder="ID Palet (Ex: HNW-A101)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <select id="transactionType" name="transactionType" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Jenis Transaksi</option>
                            <option value="Incoming">Masuk (Available)</option>
                            <option value="Outgoing">Keluar (In Use)</option>
                        </select>
                        <input type="text" id="transactionLocation" name="transactionLocation" placeholder="Lokasi Baru (Ex: Line Produksi 1)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="text" id="transactionNotes" name="transactionNotes" placeholder="Catatan Tambahan (Opsional)" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="mt-6 w-full md:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg btn-primary hover:bg-green-700">
                        Catat Transaksi
                    </button>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Riwayat Transaksi Palet (<span id="transaction-count">0</span>)</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Palet</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Transaksi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi Baru</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl p-6 w-11/12 max-w-sm card">
            <h3 id="modal-title" class="text-lg font-bold mb-3">Pesan</h3>
            <p id="modal-body" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('message-modal').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('message-modal').classList.add('opacity-0', 'pointer-events-none');" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg btn-primary">Tutup</button>
        </div>
    </div>

    <script>
        // *** URL WEB APP TELAH DIPERBARUI ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyDDp6x-07VQr3aSRqXNfWOmMEVofT-8M6NmUFhNrns0-XCeVd55SYrNC7b6qPgiLbj/exec'; 
        
        // Konstanta
        const MASTER_SHEET_NAME = 'MASTER PALET';
        const TRANSACTION_SHEET_NAME = 'Log Transaksi Palet';
        const LOADING_OVERLAY = document.getElementById('loading-overlay');
        let masterPaletsData = [];

        // --- FETCH UTILITY ---
        const callWebApp = async (payload) => {
            if (WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
                // Seharusnya tidak tercapai karena sudah diganti, tapi sebagai fallback
                throw new Error("ERROR: URL Web App belum diset.");
            }
            
            const url = `${WEB_APP_URL}?type=${payload.action}`;
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(payload).toString()
            };

            // Implementasi Exponential Backoff
            const MAX_RETRIES = 5;
            let response = null;
            let lastError = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        break; // Sukses atau error non-throttling
                    } else if (response.status === 429) {
                        // Throttling detected, wait and retry
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); // 1s, 2s, 4s, 8s, 16s + jitter
                        await new Promise(resolve => setTimeout(resolve, delay));
                        lastError = new Error(`Request throttled (429). Retrying in ${Math.round(delay/1000)}s.`);
                        // Continue loop for retry
                    } else {
                        throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                    }
                } catch (error) {
                    lastError = error;
                    // For network errors, wait before retrying
                    if (i < MAX_RETRIES - 1) {
                         const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                         await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (!response || !response.ok) {
                throw lastError || new Error("Gagal terhubung ke Apps Script setelah beberapa kali coba.");
            }
            
            const json = await response.json();
            
            if (json.status === 'error') {
                throw new Error(json.message);
            }
            return json;
        };
        
        // Utility function to show custom modal messages
        window.showMessageModal = (message, type = 'info') => {
            const modal = document.getElementById('message-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = type === 'error' ? 'Gagal!' : (type === 'success' ? 'Berhasil!' : 'Pesan');
            body.textContent = message;

            // Optional: change title color based on type
            title.className = `text-lg font-bold mb-3 ${type === 'error' ? 'text-red-600' : 'text-blue-600'}`;

            modal.classList.add('opacity-100', 'pointer-events-auto');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        };

        // --- RENDERING FUNCTIONS ---
        const renderMasterPalets = (palets) => {
            const list = document.getElementById('master-palet-list');
            document.getElementById('master-palet-count').textContent = palets.length;
            list.innerHTML = ''; 

            if (palets.length === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Belum ada data Master Palet.</td></tr>';
                return;
            }

            palets.forEach(palet => {
                const row = document.createElement('tr');
                // Status in G-Sheet is either 'Available' (Incoming) or 'In Use' (Outgoing)
                const statusClass = palet.Status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${palet.ID_Palet}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.Tipe}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${palet.Status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.Lokasi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.Kapasitas}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.Terakhir_Diperbarui}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="window.handleDeleteMasterPalet('${palet.ID_Palet}')" class="text-red-600 hover:text-red-900 ml-2">Hapus</button>
                    </td>
                `;
                list.appendChild(row);
            });
        };

        const renderTransactions = (transactions) => {
            const list = document.getElementById('transaction-list');
            document.getElementById('transaction-count').textContent = transactions.length;
            list.innerHTML = ''; 

            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data Log Transaksi Palet.</td></tr>';
                return;
            }

            // Sort: Newest first based on Timestamp (assuming the script returned it unsorted)
            transactions.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            transactions.forEach(tx => {
                const row = document.createElement('tr');
                const typeClass = tx.Tipe_Transaksi === 'Incoming' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.Timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.ID_Palet}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${typeClass}">${tx.Tipe_Transaksi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.Lokasi_Baru}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${tx.Catatan || ''}">${tx.Catatan || '-'}</td>
                `;
                list.appendChild(row);
            });
        };

        // --- MASTER PALET HANDLERS ---
        window.handleMasterPaletSubmit = async (event) => {
            event.preventDefault();
            LOADING_OVERLAY.classList.remove('hidden');

            const form = event.target;
            const formData = new FormData(form);

            const paletId = formData.get('masterPaletId').toUpperCase().trim();
            
            const paletData = {
                ID_Palet: paletId,
                Tipe: formData.get('masterPaletType'),
                Lokasi: formData.get('masterPaletLocation'),
                Kapasitas: formData.get('masterPaletCapacity'),
                Status: 'Available', 
                Terakhir_Diperbarui: new Date().toLocaleString('id-ID'),
            };

            const payload = {
                action: 'addMaster',
                data: JSON.stringify(paletData)
            };

            try {
                const result = await callWebApp(payload);
                showMessageModal(result.message, 'success');
                form.reset();
                await loadAllData(); 
            } catch (error) {
                console.error("Gagal menyimpan Palet:", error);
                showMessageModal(`Gagal menyimpan Palet: ${error.message}`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };

        window.handleDeleteMasterPalet = async (paletId) => {
            // Simple custom "confirmation" using the window.confirm
            const confirmed = window.confirm(`Yakin ingin menghapus Master Palet ID: ${paletId}?`);
            if (!confirmed) {
                return;
            }

            LOADING_OVERLAY.classList.remove('hidden');

            const payload = {
                action: 'deleteMaster',
                ID_Palet: paletId
            };

            try {
                const result = await callWebApp(payload);
                showMessageModal(result.message, 'success');
                await loadAllData();
            } catch (error) {
                console.error("Gagal menghapus Palet:", error);
                showMessageModal(`Gagal menghapus Palet: ${error.message}`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };

        // --- TRANSACTION HANDLERS ---
        window.handleTransactionSubmit = async (event) => {
            event.preventDefault();
            LOADING_OVERLAY.classList.remove('hidden');

            const form = event.target;
            const formData = new FormData(form);

            const paletId = formData.get('transactionPaletId').toUpperCase().trim();
            const transactionType = formData.get('transactionType');
            const newLocation = formData.get('transactionLocation');
            const notes = formData.get('transactionNotes');

            if (!paletId || !transactionType || !newLocation) {
                showMessageModal("Semua kolom transaksi harus diisi.", 'error');
                LOADING_OVERLAY.classList.add('hidden');
                return;
            }

            try {
                // 1. Check Palet Existence (Master Palet data must be loaded)
                const existingPalet = masterPaletsData.find(p => p.ID_Palet === paletId);
                if (!existingPalet) {
                    throw new Error(`Master Palet ID ${paletId} tidak ditemukan. Harap daftarkan palet ini terlebih dahulu.`);
                }
                
                // 2. Determine New Status and Data
                const newStatus = transactionType === 'Incoming' ? 'Available' : 'In Use';
                
                const masterUpdateData = {
                    ID_Palet: paletId,
                    Lokasi: newLocation,
                    Status: newStatus,
                    Terakhir_Diperbarui: new Date().toLocaleString('id-ID'),
                };
                
                const transactionData = {
                    ID_Palet: paletId,
                    Tipe_Transaksi: transactionType,
                    Lokasi_Baru: newLocation,
                    Catatan: notes,
                    Timestamp: new Date().toLocaleString('id-ID'),
                };

                // 3. Send combined action to Web App
                const payload = {
                    action: 'recordTransaction',
                    masterUpdate: JSON.stringify(masterUpdateData),
                    newTransaction: JSON.stringify(transactionData)
                };

                const result = await callWebApp(payload);

                showMessageModal(`Transaksi Palet ${paletId} (${transactionType}) berhasil dicatat.`, 'success');
                form.reset();
                await loadAllData(); 
                
            } catch (error) {
                console.error("Gagal mencatat transaksi. Detail Error:", error);
                showMessageModal(`Gagal mencatat transaksi: ${error.message}`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };


        // --- DATA INITIALIZATION ---
        const loadAllData = async () => {
            LOADING_OVERLAY.classList.remove('hidden');
            try {
                // 1. Fetch Master Palets
                const masterResult = await callWebApp({ action: 'getAllData', sheetName: MASTER_SHEET_NAME });
                masterPaletsData = masterResult.data; 
                renderMasterPalets(masterPaletsData);

                // 2. Fetch Transactions
                const transactionResult = await callWebApp({ action: 'getAllData', sheetName: TRANSACTION_SHEET_NAME });
                renderTransactions(transactionResult.data); // Sorting is done inside renderTransactions

            } catch (error) {
                console.error("Gagal memuat data:", error);
                showMessageModal(`Gagal memuat data. Pastikan Apps Script sudah di-deploy dan URL sudah benar. Detail Error: ${error.message}`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        }


        // --- UI & INITIALIZATION ---
        window.onload = () => {
            loadAllData();
        };

        window.switchTab = (tabName) => {
            const tabs = ['master', 'transaction'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                const content = document.getElementById(`content-${tab}`);
                if (tab === tabName) {
                    btn.classList.add('border-blue-600', 'text-blue-600');
                    btn.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-gray-300');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700', 'border-gray-300');
                    content.classList.add('hidden');
                }
            });
        };

    </script>
</body>
</html>
